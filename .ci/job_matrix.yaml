---
job: 'torch-ucc'

registry_host: 'harbor.mellanox.com'
# TODO change
registry_path: '/swx-infra/torch-ucc'
registry_auth: '1daaea28-800e-425f-a91f-3bd3e9136eea'

kubernetes:
  cloud: 'swx-k8s'

volumes:
  - { mountPath: '/hpc/local', hostPath: '/hpc/local' }
  - { mountPath: '/auto/sw_tools', hostPath: '/auto/sw_tools' }
  - { mountPath: '/.autodirect/mtrswgwork', hostPath: '/.autodirect/mtrswgwork' }
  - { mountPath: '/.autodirect/sw/release', hostPath: '/.autodirect/sw/release' }

env:
  CUDA_HOME: '/usr/local/cuda'
  UCX_BRANCH: 'v1.10.x'
  UCX_SRC_DIR: '${WORKSPACE}/ucx'
  UCX_BUILD_DIR: '${UCX_SRC_DIR}/build'
  UCX_INSTALL_DIR: '${UCX_BUILD_DIR}/_install'
  UCC_SRC_DIR: '${WORKSPACE}/ucc'
  XCCL_SRC_DIR: '${WORKSPACE}/xccl'
  XCCL_BUILD_DIR: '${XCCL_SRC_DIR}/build'
  XCCL_INSTALL_DIR: '${XCCL_BUILD_DIR}/_install'
  NCCL_SRC_DIR: '${WORKSPACE}/nccl'
  NCCL_BUILD_DIR: '${NCCL_SRC_DIR}/build'
  NCCL_GIT_REPO: 'https://github.com/nvidia/nccl.git'

runs_on_dockers:
  - { file: '.ci/Dockerfile.ubuntu18.04', name: 'ubuntu18.04', tag: 'latest', arch: 'x86_64' }

steps:
  #============================================================================
  - name: Check Env
    shell: '#!/bin/bash -eEx'
    run: |
      echo "INFO: check environment"
      find .
      printenv
      cat /proc/1/cgroup
      cat /etc/*release*
  #============================================================================
  - name: Build UCX
    shell: '#!/bin/bash -eEx'
    run: |
      echo "INFO: Build UCX"
      cd ${UCX_SRC_DIR}
      git checkout ${UCX_BRANCH}
      ${UCX_SRC_DIR}/autogen.sh
      mkdir -p ${UCX_BUILD_DIR}
      cd ${UCX_BUILD_DIR}
      ${UCX_SRC_DIR}/configure --enable-mt --with-cuda=${CUDA_HOME} --prefix=${UCX_INSTALL_DIR}
      make -j install
  #============================================================================
  - name: Build NCCL
    shell: '#!/bin/bash -eEx'
    run: |
      echo "INFO: Build NCCL"
      cd ${WORKSPACE}
      git clone ${NCCL_GIT_REPO}
      cd ${NCCL_SRC_DIR}
      make -j src.build NVCC_GENCODE="-arch=sm_70 -gencode=arch=compute_70,code=sm_70 -gencode=arch=compute_80,code=compute_80"
  #============================================================================
  - name: Build XCCL
    shell: '#!/bin/bash -eEx'
    run: |
      echo "INFO: Build XCCL"
      cd ${XCCL_SRC_DIR}
      # TODO tmp W/A
      sed -i 's|NVCCFLAGS = .*|NVCCFLAGS = "${UCS_CPPFLAGS} -I${XCCL_TOP_SRCDIR}/src -I${XCCL_TOP_SRCDIR}/src/core" --compiler-options -fno-rtti,-fno-exceptions|g' ${XCCL_SRC_DIR}/src/utils/cuda/kernels/Makefile.am
      ${XCCL_SRC_DIR}/autogen.sh
      mkdir -p ${XCCL_BUILD_DIR}
      cd ${XCCL_BUILD_DIR}
      ${XCCL_SRC_DIR}/configure --with-nccl=${NCCL_BUILD_DIR} --with-cuda=${CUDA_HOME}  --with-ucx=${UCX_INSTALL_DIR} \
        --prefix=${XCCL_INSTALL_DIR}
      make -j install
  #============================================================================
  - name: Install Torch-UCC
    run: |
      echo "INFO: Install Torch-UCC"
      cd ${WORKSPACE}
      UCX_HOME=${UCX_INSTALL_DIR}
      XCCL_HOME=${XCCL_INSTALL_DIR}
      WITH_CUDA=${CUDA_HOME}
      python setup.py install
  #============================================================================
