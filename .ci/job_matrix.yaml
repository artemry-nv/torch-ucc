---
job: 'torch-ucc'

registry_host: 'harbor.mellanox.com'
# TODO change
registry_path: '/swx-infra/torch-ucc'
registry_auth: '1daaea28-800e-425f-a91f-3bd3e9136eea'

kubernetes:
  cloud: 'swx-k8s'

volumes:
  - { mountPath: '/hpc/local', hostPath: '/hpc/local' }
  - { mountPath: '/auto/sw_tools', hostPath: '/auto/sw_tools' }
  - { mountPath: '/.autodirect/mtrswgwork', hostPath: '/.autodirect/mtrswgwork' }
  - { mountPath: '/.autodirect/sw/release', hostPath: '/.autodirect/sw/release' }

env:
  CUDA_HOME: '/usr/local/cuda'
  UCX_BRANCH: 'v1.10.x'

runs_on_dockers:
  - { file: '.ci/Dockerfile.ubuntu20.04', name: 'ubuntu20.04', tag: 'latest', arch: 'x86_64' }

steps:
  - name: tester
    shell: '#!/bin/bash -eEx'
    run: |
      echo "INFO: tester"
      find .
      printenv
      cat /proc/1/cgroup
      cat /etc/*release*
  - name: Build UCX
    shell: '#!/bin/bash -eEx'
    run: |
      echo "INFO: Build UCX"
      UCX_SRC_DIR="${WORKSPACE}/ucx"
      cd ${UCX_SRC_DIR}
      git checkout ${UCX_BRANCH}
      ${WORKSPACE}/ucx/autogen.sh
      mkdir -p ${UCX_SRC_DIR}/build-debug
      #cd ${UCX_SRC_DIR}/build-debug
      #${UCX_SRC_DIR}/configure --enable-debug-data --enable-frame-pointers --enable-stats \
      #  --enable-memtrack --enable-fault-injection --enable-mt \
      #  --with-cuda=${CUDA_HOME} \
      #  --prefix=${UCX_SRC_DIR}/build-debug/install
      #make -j install
      mkdir -p ${UCX_SRC_DIR}/build-release
      cd ${UCX_SRC_DIR}/build-release
      ${UCX_SRC_DIR}/configure --enable-mt --with-cuda=${CUDA_HOME} --prefix=${UCX_SRC_DIR}/build-release/install
      make -j install
  - name: Build UCC
      shell: '#!/bin/bash -eEx'
      run: |
        echo "INFO: Build UCC"
  - name: Build XCCL
      shell: '#!/bin/bash -eEx'
      run: |
        echo "INFO: Build XCCL"
