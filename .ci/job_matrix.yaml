---
job: 'torch-ucc'

registry_host: 'harbor.mellanox.com'
# TODO change
registry_path: '/swx-infra/torch-ucc'
registry_auth: '1daaea28-800e-425f-a91f-3bd3e9136eea'

kubernetes:
  cloud: 'swx-k8s'

volumes:
  - { mountPath: '/hpc/local', hostPath: '/hpc/local' }
  - { mountPath: '/auto/sw_tools', hostPath: '/auto/sw_tools' }
  - { mountPath: '/.autodirect/mtrswgwork', hostPath: '/.autodirect/mtrswgwork' }
  - { mountPath: '/.autodirect/sw/release', hostPath: '/.autodirect/sw/release' }

env:
  # build_dockers should be always 'true' (because CI building is a part of docker building process)
  build_dockers: 'true'
  TORCH_UCC_URI_SUFFIX: '${TORCH_UCC_VERSION}/x86_64/ubuntu20.04'

runs_on_dockers:
  - {
    file: '.ci/Dockerfile.ubuntu20.04',
    name: 'ubuntu20.04',
    tag: 'latest',
    arch: 'x86_64',
    uri: $TORCH_UCC_URI_SUFFIX
  }

# TODO debug
timeout_minutes: 180

steps:
  #============================================================================
  - name: Check Env
    run: |
      echo "INFO: check environment"
      printenv
      cat /proc/1/cgroup
      cat /etc/*release*
      id
      find /opt/nvidia
  #============================================================================
  #  - name: Run XCCL tests
  #    run: |
  #      echo "INFO: Run XCCL tests"
  #      ${WORKSPACE}/.ci/scripts/run_tests_xccl.sh
  #      #sleep 10000
  #============================================================================
  #  - name: Install Torch-UCC
  #    run: |
  #      echo "INFO: Install Torch-UCC"
  #      cd ${WORKSPACE}
  #      UCX_HOME=${UCX_INSTALL_DIR} \
  #      XCCL_HOME=${XCCL_INSTALL_DIR} \
  #      WITH_CUDA=${CUDA_HOME} \
  #      python setup.py install
  #      pip3 list | grep torch
  #      #export LD_LIBRARY_PATH=${UCX_INSTALL_DIR}/lib:${XCCL_INSTALL_DIR}/lib:${LD_LIBRARY_PATH}
  #      python -c 'import torch, torch_ucc'
  #============================================================================
  #  - name: Run Torch-UCC tests
  #    run: |
  #      echo "INFO: Run Torch-UCC tests"
  #      ${WORKSPACE}/.ci/scripts/run_tests_torch_ucc.sh
  #============================================================================
  #  - name: Prepare Torch-UCC package
  #    run: |
  #      echo "INFO: Prepare Torch-UCC package"
  #      cd ${WORKSPACE}
  #      UCX_HOME=${UCX_INSTALL_DIR} \
  #      XCCL_HOME=${XCCL_INSTALL_DIR} \
  #      WITH_CUDA=${CUDA_HOME} \
  #      python3 setup.py bdist_wheel
  #      #python3 setup.py sdist bdist_wheel
  #      find dist
  #      #sleep 10000
  #============================================================================
